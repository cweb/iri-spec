<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd">
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc compact="yes"?>
<?rfc iprnotified="no" ?>
<?rfc strict="yes"?>
<?rfc symrefs="yes"?>
<?rfc toc="yes"?>
<?rfc tocdepth="4"?>

<rfc category="std" docName="draft-weber-iri-guidelines-00" ipr="trust200902">

  <front>
    <title abbrev="IRI Guidelines">Guidelines for Implementers of Internationalized Resource Identifiers (IRIs)</title>

    <author initials="C." surname="Weber" fullname="Chris Weber">
      <organization>Casaba Security</organization>
      <address>
        <postal>
          <street>16625 Redmond Wa, Suite M348</street>
          <city>Redmond</city>
          <region>WA</region>
          <code>98052</code>
          <country>USA</country>
        </postal>
        <email>chris@lookout.net</email>
      </address>
    </author>
    <author initials="P." surname="Saint-Andre" fullname="Peter Saint-Andre">
      <organization>Cisco</organization>
      <address>
        <postal>
          <street>1899 Wyknoop Street, Suite 600</street>
          <city>Denver</city>
          <region>CO</region>
          <code>80202</code>
          <country>USA</country>
        </postal>
        <phone>+1-303-308-3282</phone>
        <email>psaintan@cisco.com</email>
      </address>
    </author>

    <date month="June" day="15" year="2011"/>

    <area>Applications</area>
    <keyword>Internet-Draft</keyword>
    <keyword>Uniform Resource Identifiers</keyword>
    <keyword>Internationalized Resource Identifiers</keyword>
    <keyword>internationalization</keyword>

    <abstract>
      <t>Some members of the implementation community have been confused about the rules and algorithms for processing Internationalized Resource Identifiers (IRIs).  This document claries these matters to improve interoperability.</t>
    </abstract>
  </front>

  <middle>

    <section title="Introduction" anchor="introduction">
      <t>Some members of the implementation community have been confused about the rules and algorithms for processing Internationalized Resource Identifiers (IRIs).  This document clarifies these matters to improve interoperability by describing the process for preparing and parsing arbitrary Unicode strings into IRI sub-components.</t>
      <t>TODO: Apply scheme-specific rules as a post-processing step?</t>
      <t>TODO: Rules for producing a canonical form of any IRI for use in comparison?</t>
    </section>
    
    <section title="Terminology" anchor="terminology">
      <t>This section defines the terminology used in this document.</t>
    </section>

    <section title="Sources" anchor="sources">
      <t>This document makes reference to the following sources of information about the parsing of IRIs:</t>
      <t>
        <list style='hanging'>
          <t hangText='1:'>Internationalized Resource Identifiers (IRIs) as specified in http://tools.ietf.org/html/draft-ietf-iri-3987bis-05 <xref target='1'/></t>
          <t hangText='2:'>Parsing URLs for Fun and Profit, http://tools.ietf.org/html/draft-abarth-url-01 <xref target='2'/></t>
          <t hangText='3:'>HTML Living Standard: URLs, http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#urls <xref target='3'/></t>
          <t hangText='4:'>Change proposal for ISSUE-56, http://lists.w3.org/Archives/Public/public-html/2010Jul/0036.html <xref target='4'/></t>
          <t hangText='5:'>URIs, URLs, and URNs: Clarifications and Recommendations 1.0, http://www.w3.org/TR/uri-clarification/ <xref target='5'/></t>
          <t hangText='6:'>Browser Security Handbook: Uniform Resource Locators, http://code.google.com/p/browsersec/wiki/Part1#Uniform_Resource_Locators <xref target='6'/></t>
          <t hangText='7:'>BIDI URL Display, https://docs.google.com/document/d/1c8-svx7og0qBUfGBobw7LYfOcNeDVPYbNVMNpSqYCFo/edit?hl=en <xref target='7'/></t>
        </list>
      </t>
    </section>
    
    <section title="Pre-processing Arbitrary Unicode Strings" anchor="pre-process">
      <t>This section describes the pre-processing steps required to prepare an arbitrary Unicode string for later parsing into IRI sub-components.</t>
      <t>
        <list style='numbers'>
          <!-- STEP 1 -->
          <t>
            Remove leading and trailing instances of whitespace (U+0020), CR (U+000A), LF (U+000D), and TAB (U+0009) characters from the string.
            <vspace/>
            Reference: Section 7.2 of <xref target='1'/> for details.
          </t>
          <!-- STEP 2 -->
          <t>
            If more than one reference is allowed, split the string into separate strings on blocks of contiguous whitespace.  If more than one reference is not allowed, either remove blocks of contiguous whitespace or replace them with a single percent-encoded U+0020 SPACE, written as "%20", depending on what is required for the current context.
            <vspace/>
            Reference: Mentioned in <xref target='4'/>.
          </t>
          <!-- STEP 3 -->
          <t>
            Determine if input string is in a Unicode-based character encoding such as UTF-8 or UTF-16.  If not in a Unicode encoding form then transcode to UTF-8.
            <vspace/>
            Reference: Section 3.1 of <xref target='1'/>.
          </t>
          <!-- STEP 4 -->
          <t>
            Normalize the Unicode-encoded string using Unicode Normalization Form C <xref target='8'/>.
            <vspace/>
            Reference: Section 3.1 of <xref target='1'/>.
          </t>
        </list>
      </t>
      <t>At this point the IRI string will be ready for parsing.</t>
    </section>

    <section title="Parsing Unicode Strings into IRI Components" anchor="parse">
      <t>With an arbitrary IRI string that has been through pre-processing, this section describes the process of parsing the IRI into its five major sub-components using rules defined by 3896 (using an algorithm equivalent to RFC3986 Appendix B) but with updated ABNF of 3987.  These rules are summarized here.           
      <vspace/>
      Reference: Section 3.2 of <xref target='1'/>.
      </t> 
      <section title="Identify the scheme" anchor="parse">
      <t>If the current string does not contain a ":" U+003A then the string does not contain a scheme and may be handled as a relative reference.  </t>
      <t>
        <list style="symbols">
          <t>Continue to "Identify the path"</t>
          <t>Abort further scheme processing</t>
        </list>
      </t>
      <t>If the first character of the string is not an ALPHA then this is not a valid scheme and may be handled as a relative reference.</t>
      <t>	
    	<list style="symbols">
          <t>Continue to "Identify the path"</t>
          <t>Abort further scheme processing</t>
        </list>
      </t>
      <t>Consume all characters up to but not including the first occurrence of ":" U+003A.  If this substring contains any characters other than ALPHA *( ALPHA / DIGIT / "+" / "-" / "." ) then it is not a valid scheme and may be handled as a relative reference.</t>
      <t>	
    	<list style="symbols">
          <t>Continue to "Identify the path"</t>
          <t>Abort further scheme processing</t>
        </list>
      </t>
      <t>The consumed substring is the scheme.  Skip over the ":" U+003A character.  Continue parsing the remaining string.</t>
      </section>
      
      <section title="Identify the authority" anchor="parse">
        <t>
	        HOST (i.e., ireg-name)
	        <vspace/>
	        [TODO We need a MUST statement here]
	        <vspace/>
	        Given an input string ireg-part, SHOULD convert the ireg-part component to percent-encoding using step 6 below.
	        <vspace/>
	        [NOTE: MAY convert ireg-part to punycode.]
	        <vspace/>
	        [NOTE The HOST should not be altered for local intranet host names]
        </t>
      </section>
      
      <section title="Identify the path" anchor="parse">
      </section>
      
      <section title="Identify the query" anchor="parse">
		<t>
		QUERY (i.e., iquery)
		<vspace/>
		Reference: Section 3.5 of <xref target='1'/>.
		<vspace/>
		((NOTE: SEE ISSUES LIST)) For compatibility with existing deployed HTTP infrastructure, the following special case applies for schemes "http" and "https" and IRIs whose origin has a document charset other than one which is UCS-based (e.g., UTF-8 or UTF-16).  In such a case, the "query" component of an IRI is mapped into a URI by using the document charset rather than UTF-8 as the binary representation before pct-encoding.  This mapping is not applied for any other scheme or component.
		</t>
      </section>
      
      <section title="Identify the fragment" anchor="parse">
      </section>

    </section>
    
    
    <section title="Scheme-Specific Processing" anchor="scheme-specific">
    </section>
    
    <section title="IRI Canonicalization" anchor="canonicalization">
      <t>To follow.</t>
  		<t>
        <!-- TODO -->
        [TODO: This seems to be the primary area of concerns for HTML developers]
        [NOTE: Call out Special Case here or in canonicalization? The U+005C should be either percent-encoded or converted to U+002F.
        
        Of course, folks who want to name such files will want to use the
        escaped form of \ in order for their site to work in other browsers.
        </t>
      	<t>
            Percent-encode IRI components (this is done for the sake of interoperability).  For each character which is not allowed anywhere in a valid URI, apply the following steps.
            <vspace/>
            Reference: Section 3.5 of <xref target='1'/>.
            <list style='symbols'>
              <t>
              Action: Convert to UTF-8, i.e., convert the character to a sequence of one or more octets using UTF-8 [RFC3629].
              <vspace/>
              [TODO: Necessary after step 3 above?)
              </t>
              <t>
                Action: Percent-encode, i.e., convert each octet of this sequence to %HH, where HH is the hexadecimal notation of the octet value.
              </t>
            </list>
		</t>
            
      <t>At this point the IRI string and components should be canonicalized.</t>
    </section>

    <section title="Security Considerations" anchor="security">
      <t>To follow.</t>
    </section>

    <section title="IANA Considerations" anchor="iana">
      <t>This document has no actions for the IANA.</t>
    </section>

    <section title="Acknowledgements" anchor="acks">
      <t>Thanks to Adam Barth, Martin Duerst, and Julian Reschke for their feedback.</t>
    </section>

  </middle>

  <back>

    <references title="Informative References">

<reference anchor='1'>
<front>
<title>Internationalized Resource Identifiers (IRIs)</title>
<author initials='M' surname='Duerst' fullname='Martin Duerst'>
    <organization />
</author>
<author initials='M' surname='Suignard' fullname='Michel Suignard'>
    <organization />
</author>
<author initials='L' surname='Masinter' fullname='Larry Masinter'>
    <organization />
</author>
<date month='March' day='29' year='2011' />
<abstract><t>This document defines the Internationalized Resource Identifier (IRI) protocol element, as an extension of the Uniform Resource Identifier (URI).  An IRI is a sequence of characters from the Universal Character Set (Unicode/ISO 10646).  Grammar and processing rules are given for IRIs and related syntactic forms.  In addition, this document provides named additional rule sets for processing otherwise invalid IRIs, in a way that supports other specifications that wish to mandate common behavior for 'error' handling.  In particular, rules used in some XML languages (LEIRI) and web applications are given.  Defining IRI as new protocol element (rather than updating or extending the definition of URI) allows independent orderly transitions: other protocols and languages that use URIs must explicitly choose to allow IRIs.  Guidelines are provided for the use and deployment of IRIs and related protocol elements when revising protocols, formats, and software components that currently deal only with URIs.  RFC Editor: Please remove the next paragraph before publication.  This document is intended to update RFC 3987 and move towards IETF Draft Standard.  For discussion and comments on this draft, please join the IETF IRI WG by subscribing to the mailing list public-iri@w3.org.  For a list of open issues, please see the issue tracker of the WG at http://trac.tools.ietf.org/wg/iri/trac/report/1. For a list of individual edits, please see the change history at http://trac.tools.ietf.org/wg/iri/trac/log/draft-ietf-iri-3987bis.</t></abstract>
</front>
<seriesInfo name='Internet-Draft' value='draft-ietf-iri-3987bis-05' />
<format type='TXT'
        target='http://www.ietf.org/internet-drafts/draft-ietf-iri-3987bis-05.txt' />
</reference>

<reference anchor='2'>
<front>
<title>How Browsers Process URLs</title>
<author initials='A' surname='Barth' fullname='Adam Barth'>
    <organization />
</author>
<date month='April' day='23' year='2011' />
<abstract><t>This document contains a precise specification of how browsers process URLs.  The behavior specified in this document might or might not match any particular browser, but browsers might be well-served by adopting the behavior defined herein.Editorial Note (To be removed by RFC Editor)  If you have suggestions for improving this document, please send email to &lt;mailto:public-iri@w3.org>.  Further Working Group information is available from &lt;https://tools.ietf.org/wg/iri/>.</t></abstract>
</front>
<seriesInfo name='Internet-Draft' value='draft-abarth-url-00' />
<format type='TXT'
        target='http://www.ietf.org/internet-drafts/draft-abarth-url-00.txt' />
</reference>

<reference anchor='3' target='http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#urls'>
<front>
<title>HTML Living Standard: URLs</title>
<author initials='I.' surname='Hickson' fullname='Ian Hickson'>
    <organization>Google</organization>
</author>
<date year='2011'/>
</front>
<seriesInfo name='WHATWG' value='?' />
<format type='HTML' target='http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#urls'/>
</reference>

<reference anchor='4' target='http://lists.w3.org/Archives/Public/public-html/2010Jul/0036.html'>
<front>
<title>Change proposal for ISSUE-56</title>
<author initials='R.' surname='Fielding' fullname='Roy Fielding'>
    <organization/>
</author>
<date day='14' month='July' year='2010'/>
</front>
<format type='HTML' target='http://lists.w3.org/Archives/Public/public-html/2010Jul/0036.html'/>
</reference>

<reference anchor='5' target='http://www.w3.org/TR/uri-clarification/'>
<front>
<title>URIs, URLs, and URNs: Clarifications and Recommendations 1.0</title>
<author fullname='URI Planning Interest Group'>
    <organization>W3C</organization>
</author>
<date day='21' month='September' year='2001'/>
</front>
<seriesInfo name='W3C Note' value='21 September 2001' />
<format type='HTML' target='http://www.w3.org/TR/uri-clarification/'/>
</reference>

<reference anchor='6' target='http://code.google.com/p/browsersec/wiki/Part1#Uniform_Resource_Locators'>
<front>
<title>Browser Security Handbook: Uniform Resource Locators</title>
<author initials='M.' surname='Zalewski' fullname='Michal Zalewski'>
    <organization>Google</organization>
</author>
<date day='6' month='March' year='2011'/>
</front>
<format type='HTML' target='http://code.google.com/p/browsersec/wiki/Part1#Uniform_Resource_Locators'/>
</reference>

<reference anchor='7' target='https://docs.google.com/document/d/1c8-svx7og0qBUfGBobw7LYfOcNeDVPYbNVMNpSqYCFo/edit?hl=en'>
<front>
<title>URLs</title>
<author initials='M.' surname='Davis' fullname='Mark Davis'>
    <organization>Google</organization>
</author>
<date day='5' month='May' year='2011'/>
</front>
<format type='HTML' target='https://docs.google.com/document/d/1c8-svx7og0qBUfGBobw7LYfOcNeDVPYbNVMNpSqYCFo/edit?hl=en'/>
</reference>

<reference anchor='8' target='http://www.unicode.org/unicode/reports/tr15/tr15-23.html'>
<front>
<title>URLs</title>
<author initials='M.' surname='Davis' fullname='Mark Davis'></author>
<author initials='M.' surname='Duerst' fullname='Martin Duerst'>
    <organization>Google</organization>
</author>
<date day='17' month='April' year='2003'/>
</front>
<format type='HTML' target='http://www.unicode.org/unicode/reports/tr15/tr15-23.html'/>
</reference>

    </references>

  </back>
</rfc>
